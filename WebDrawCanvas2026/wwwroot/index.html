<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Studio Canvas Pro 2026</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            --bg-darker: #111111;
            --bg-panel: #1a1a1a;
            --bg-button: #282828;
            --accent: #3b82f6;
            --border: #333;
            --text: #e5e7eb;
            --text-muted: #9ca3af;
        }

        body {
            margin: 0;
            display: flex;
            height: 100vh;
            font-family: 'Inter', -apple-system, sans-serif;
            background: var(--bg-darker);
            color: var(--text);
            overflow: hidden;
        }

        /* --- SIDEBAR TOOLS --- */
        #toolbar-left {
            width: 60px;
            background: var(--bg-panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 15px 0;
            gap: 8px;
        }

        .tool-btn {
            width: 42px;
            height: 42px;
            background: var(--bg-button);
            border: 1px solid var(--border);
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: 0.1s;
            border-radius: 4px; /* Slightly squared */
        }

        .tool-btn:hover { background: #333; color: white; border-color: #555; }
        .tool-btn.active { background: var(--accent); color: white; border-color: var(--accent); }

        /* --- WORKSPACE --- */
        #workspace {
            flex-grow: 1;
            background: #0d0d0d;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

        #canvas-frame {
            position: relative;
            background: white;
            box-shadow: 0 0 50px rgba(0,0,0,0.8);
            width: 800px;
            height: 600px;
        }

        canvas { position: absolute; top: 0; left: 0; }

        /* --- RIGHT PANEL --- */
        #sidebar-right {
            width: 280px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow-y: auto;
        }

        .section { padding: 20px; border-bottom: 1px solid var(--border); }
        .section-title { font-size: 11px; text-transform: uppercase; font-weight: 700; color: var(--text-muted); margin-bottom: 15px; letter-spacing: 0.5px; }

        /* --- COLOR PICKER --- */
        #color-engine { display: flex; flex-direction: column; gap: 15px; align-items: center; }
        #color-triangle {
            width: 180px;
            height: 180px;
            background: linear-gradient(to bottom, transparent, #000), linear-gradient(to right, #fff, transparent), red;
            background-blend-mode: normal;
            position: relative;
            cursor: crosshair;
            border: 1px solid var(--border);
        }

        .slider-group { width: 100%; display: flex; flex-direction: column; gap: 5px; font-size: 12px; }
        input[type="range"] { width: 100%; accent-color: var(--accent); cursor: pointer; }

        /* --- LAYERS --- */
        #layer-container { display: flex; flex-direction: column; gap: 8px; }
        .layer-row {
            background: var(--bg-button);
            border: 1px solid var(--border);
            padding: 10px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            cursor: pointer;
        }
        .layer-row.selected { border-color: var(--accent); background: #2a2d35; }
        .layer-meta { display: flex; justify-content: space-between; align-items: center; }
        
        select, .btn-action {
            background: #111;
            color: white;
            border: 1px solid var(--border);
            padding: 5px;
            font-size: 11px;
            border-radius: 2px;
        }

        .btn-full { width: 100%; padding: 10px; background: var(--accent); border: none; font-weight: bold; cursor: pointer; margin-top: 10px; color: white; }
    </style>
</head>
<body>

    <div id="toolbar-left">
        <button class="tool-btn active" onclick="setTool('brush')" title="Brush (B)" id="btn-brush"><i data-lucide="paintbrush"></i></button>
        <button class="tool-btn" onclick="setTool('blend')" title="Smudge/Blend (S)" id="btn-blend"><i data-lucide="sparkles"></i></button>
        <button class="tool-btn" onclick="setTool('eraser')" title="Eraser (E)" id="btn-eraser"><i data-lucide="eraser"></i></button>
        <button class="tool-btn" onclick="setTool('fill')" title="Paint Bucket (G)" id="btn-fill"><i data-lucide="paint-bucket"></i></button>
        <div style="flex-grow: 1;"></div>
        <button class="tool-btn" onclick="clearLayer()" title="Clear Active Layer"><i data-lucide="refresh-ccw"></i></button>
        <button class="tool-btn" onclick="downloadImage()" title="Save as PNG"><i data-lucide="download"></i></button>
    </div>

    <div id="workspace">
        <div id="canvas-frame" id="frame">
            </div>
    </div>

    <div id="sidebar-right">
        <div class="section">
            <div class="section-title">Color Mixer</div>
            <div id="color-engine">
                <div id="color-triangle" onclick="pickColor(event)"></div>
                
                <div class="slider-group">
                    <label>Hue</label>
                    <input type="range" min="0" max="360" value="0" id="hue-slider" oninput="updateHue()">
                    <label>Opacity: <span id="op-val">100</span>%</label>
                    <input type="range" min="0" max="100" value="100" id="opacity-slider" oninput="updateAlpha()">
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">Brush Settings</div>
            <div class="slider-group">
                <label>Size: <span id="sz-val">20</span>px</label>
                <input type="range" min="1" max="150" value="20" id="size-slider" oninput="updateSize()">
                <label>Hardness</label>
                <input type="range" min="0" max="100" value="100" id="hardness-slider">
            </div>
        </div>

        <div class="section" style="flex-grow: 1;">
            <div class="section-title">Layers</div>
            <div id="layer-container"></div>
            <button class="btn-full" onclick="addLayer()" title="Add new empty layer">+ NEW LAYER</button>
        </div>
    </div>

    <script>
        const frame = document.getElementById('canvas-frame');
        const layerCont = document.getElementById('layer-container');
        let layers = [];
        let activeIdx = -1;
        let isDrawing = false;
        let currentTool = 'brush';
        
        let brushColor = "rgba(255, 0, 0, 1)";
        let brushSize = 20;
        let currentHue = 0;
        let currentAlpha = 1;

        // --- COLOR PICKER LOGIC ---
        function updateHue() {
            currentHue = document.getElementById('hue-slider').value;
            document.getElementById('color-triangle').style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
            updateColorString();
        }

        function updateAlpha() {
            currentAlpha = document.getElementById('opacity-slider').value / 100;
            document.getElementById('op-val').innerText = Math.round(currentAlpha * 100);
            updateColorString();
        }

        function pickColor(e) {
            const rect = e.target.getBoundingClientRect();
            const s = (e.clientX - rect.left) / rect.width * 100;
            const v = 100 - ((e.clientY - rect.top) / rect.height * 100);
            // Conversion roughly for UI feel
            brushColor = `hsla(${currentHue}, ${s}%, ${v/2 + 25}%, ${currentAlpha})`;
            updateColorString();
        }

        function updateColorString() {
            // Placeholder logic to keep color persistent
        }

        function updateSize() {
            brushSize = document.getElementById('size-slider').value;
            document.getElementById('sz-val').innerText = brushSize;
        }

        // --- LAYER MGMT ---
        function addLayer() {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d', {willReadFrequently: true});
            
            const l = {
                id: Date.now(),
                name: "Layer " + (layers.length + 1),
                canvas, ctx, visible: true, blend: 'normal'
            };
            layers.push(l);
            frame.appendChild(canvas);
            selectL(layers.length - 1);
            renderL();
        }

        function selectL(i) { activeIdx = i; renderL(); }

        function renderL() {
            layerCont.innerHTML = '';
            [...layers].reverse().forEach((l, ri) => {
                const i = layers.length - 1 - ri;
                const div = document.createElement('div');
                div.className = `layer-row ${i === activeIdx ? 'selected' : ''}`;
                div.onclick = () => selectL(i);
                div.innerHTML = `
                    <div class="layer-meta">
                        <span style="font-weight:bold; font-size:12px">${l.name}</span>
                        <input type="checkbox" ${l.visible?'checked':''} onclick="toggleL(${i})">
                    </div>
                    <select onchange="changeBlend(${i}, this.value)">
                        <option value="normal" ${l.blend=='normal'?'selected':''}>Normal</option>
                        <option value="multiply" ${l.blend=='multiply'?'selected':''}>Multiply</option>
                        <option value="screen" ${l.blend=='screen'?'selected':''}>Screen</option>
                        <option value="overlay" ${l.blend=='overlay'?'selected':''}>Overlay</option>
                    </select>
                `;
                layerCont.appendChild(div);
            });
        }

        function toggleL(i) { 
            layers[i].visible = !layers[i].visible; 
            layers[i].canvas.style.opacity = layers[i].visible ? 1 : 0;
        }

        function changeBlend(i, v) { 
            layers[i].blend = v; 
            layers[i].canvas.style.mixBlendMode = v; 
        }

        // --- DRAWING ---
        let lx, ly;
        frame.onmousedown = (e) => {
            if (activeIdx === -1) return;
            isDrawing = true;
            const rect = frame.getBoundingClientRect();
            lx = e.clientX - rect.left;
            ly = e.clientY - rect.top;
            
            if (currentTool === 'fill') doFill(lx, ly);
        };

        window.onmousemove = (e) => {
            if (!isDrawing || activeIdx === -1 || currentTool === 'fill') return;
            const rect = frame.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            const ctx = layers[activeIdx].ctx;

            ctx.lineWidth = brushSize;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';

            if (currentTool === 'eraser') {
                ctx.globalCompositeOperation = 'destination-out';
                stroke(ctx, lx, ly, x, y);
            } else if (currentTool === 'blend') {
                ctx.globalCompositeOperation = 'source-over';
                smudge(ctx, x, y);
            } else {
                ctx.globalCompositeOperation = 'source-over';
                ctx.strokeStyle = brushColor;
                // Basic airbrush feel
                const hardness = document.getElementById('hardness-slider').value / 100;
                ctx.globalAlpha = hardness; 
                stroke(ctx, lx, ly, x, y);
                ctx.globalAlpha = 1.0;
            }
            lx = x; ly = y;
        };

        window.onmouseup = () => isDrawing = false;

        function stroke(ctx, x1, y1, x2, y2) {
            ctx.beginPath(); ctx.moveTo(x1, y1); ctx.lineTo(x2, y2); ctx.stroke();
        }

        function smudge(ctx, x, y) {
            const s = parseInt(brushSize);
            const data = ctx.getImageData(x-s/2, y-s/2, s, s);
            ctx.putImageData(data, x-s/2 + (Math.random()*2-1), y-s/2 + (Math.random()*2-1));
        }

        function setTool(t) {
            currentTool = t;
            document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
            document.getElementById('btn-'+t).classList.add('active');
        }

        function clearLayer() {
            if(activeIdx !== -1) layers[activeIdx].ctx.clearRect(0,0,800,600);
        }

        function downloadImage() {
            const temp = document.createElement('canvas');
            temp.width = 800; temp.height = 600;
            const tctx = temp.getContext('2d');
            layers.forEach(l => { if(l.visible) tctx.drawImage(l.canvas, 0, 0); });
            const link = document.createElement('a');
            link.download = 'artwork.png';
            link.href = temp.toDataURL();
            link.click();
        }

        // --- KEYBOARD SHORTCUTS ---
        window.addEventListener('keydown', (e) => {
            if (e.key.toLowerCase() === 'b') setTool('brush');
            if (e.key.toLowerCase() === 'e') setTool('eraser');
            if (e.key.toLowerCase() === 's') setTool('blend');
            if (e.key.toLowerCase() === 'g') setTool('fill');
            if (e.key === '[') { brushSize = Math.max(1, brushSize-5); updateSize(); }
            if (e.key === ']') { brushSize = Math.min(150, parseInt(brushSize)+5); updateSize(); }
        });

        lucide.createIcons();
        addLayer();
        updateHue(); // Init color
    </script>
</body>
</html>